<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Authentification API DEMO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>
  </head>
  <body>
    <div class="section">
      <div class="container">
        <h1 class="title">Web Authentification API DEMO</h1>
        <div class="box">
          <p>status: <strong id="status">Please Login</strong></p>
        </div>
        <div class="columns">

          <div class="column">
            <div class="box">
              <h2 class="title is-4">Register</h2>
              <form name="register" method="post">
                <div class="field">
                  <label class="label">Name</label>
                  <div class="control">
                    <input type="text" class="input" name="username" value="Your Name" />
                  </div>
                </div>
                <div class="field">
                  <div class="control">
                    <button type="submit" class="button is-primary">Register</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="column">
            <div class="box">
              <h2 class="title is-4">Login</h2>
              <form name="login" method="post">
                <div class="field">
                  <label class="label">Name</label>
                  <div class="control">
                    <input type="text" class="input" name="username" value="Your Name" />
                  </div>
                </div>
                <div class="field">
                  <div class="control">
                    <button type="submit" class="button is-primary">Login</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="column">
            <div class="box">
              <h2 class="title is-4">Logout</h2>
              <form name="logout" method="post">
                <div class="field">
                  <div class="control">
                    <button type="submit" class="button is-primary">Logout</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script>
      let userId = null
      const registerForm = document.forms.register
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault()

        const username = registerForm.username.value
        const publicKeyCredentialCreationOptions = {
          rp: {
            name: "Web Authentification API DEMO",
          },
          user: {
            id: new Uint8Array(16),
            name: username,
            displayName: username,
          },
          challenge: new Uint8Array([
            0x8C, 0x0A, 0x26, 0xFF, 0x22, 0x91, 0xC1, 0xE9, 0xB9, 0x4E, 0x2E, 0x17, 0x1A, 0x98, 0x6A, 0x73,
            0x71, 0x9D, 0x43, 0x48, 0xD5, 0xA7, 0x6A, 0x15, 0x7E, 0x38, 0x94, 0x52, 0x77, 0x97, 0x0F, 0xEF
          ]).buffer,
          pubKeyCredParams: [
            {
              alg: -7,
              type: "public-key",
            }
          ],
          excludeCredentials: [
            {
              type: "public-key",
              id: new Uint8Array(16),
            }
          ],
          authentificatorSelection: {
            requireResidentKey: false,
            userVerification: "preferred",
          },
          attestation: "direct",
          timeout: 10000,
        }

        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        })

        document.getElementById("status").innerHTML = `Login as ${username}`
        userId = credential.id

        console.log("credential: ", credential)
        console.log("userId: ", userId)
      })

      const loginForm = document.forms.login
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault()

        const username = loginForm.username.value
        const publicKeyCredentialRequestOptions = {
          challenge: new Uint8Array([
            0x79, 0x50, 0x68, 0x71, 0xDA, 0xEE, 0xEE, 0xB9, 0x94, 0xC3, 0xC2, 0x15, 0x67, 0x65, 0x26, 0x22,
            0xE3, 0xF3, 0xAB, 0x3B, 0x78, 0x2E, 0xD5, 0x6F, 0x81, 0x26, 0xE2, 0xA6, 0x01, 0x7D, 0x74, 0x50
          ]).buffer,
          allowCredentials: [
            {
              type: "public-key",
              id: b64dec(userId),
            }
          ],
          timeout: 10000,
        }

        const credential = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        })

        document.getElementById("status").innerHTML = `Login as ${username}`
        console.log("credential: ", credential)
      })

      const logoutForm = document.forms.logout
      logoutForm.addEventListener("submit", async (e) => {
        e.preventDefault()
        document.getElementById("status").innerHTML = "Please Login"
      })

      function b64dec(b64str, opt={ urlsafe: true }) {
        if (opt.urlsafe) {
          const len = b64str.length
          b64str = b64str
            .replace(/-/g, "+")
            .replace(/_/g, "/")
            .padEnd(len+((4-len%4)%4), "=")
        }
        return new Uint8Array([...atob(b64str)].map((e) => e.charCodeAt(0)))
      }
    </script>
  </body>
</html>
